---
import SocialList from "@/components/SocialList.astro";
import PageLayout from "@/layouts/Base.astro";
import { Icon } from "astro-icon/components";
import { Image } from "astro:assets";
import { getEntry } from "astro:content";

// =========================
// EDITABLE CONTENT (edit here)
// =========================

type PublicationEditable = {
	author: string[];
	title: string;
	booktitle: string;
	time?: string;
	doi?: string;
	paper?: string;
	code?: string;
	image?: string;
	venueIcon?: string;
	venueColor?: string;
	venueRank?: string;
	venueLogo?: string;
	abstract?: string;
};

type PublicationResolved = Omit<PublicationEditable, "image" | "venueLogo"> & {
	image: any | null;
	fullSrc: string;
	venueLogo: any | null;
};

type NewsItem = {
	date: string;
	html?: string;
	text?: string;
	href?: string;
	label?: string;
};

type ProjectEditable = {
	name: string;
	description: string;
	tags?: string[];
	time?: string;
	repo?: string;
	demo?: string;
	paper?: string;
	orgLogos?: string[];
};

type HomeIntroSegment =
	| { type: "text"; html: string }
	| { type: "link"; name: string; href: string; class?: string }
	| { type: "org"; key: string; name: string; href: string; alt?: string; width?: number; class?: string };

type HomeIntro = { paragraphs: { segments: HomeIntroSegment[] }[] };

type AckPerson = { name: string; href: string };
type Acknowledgements = {
	title: string;
	introLines?: string[];
	mentors?: AckPerson[];
	peersIntro?: string;
	peers?: AckPerson[];
	outro?: string;
};

type PersonalPhilosophy = {
	intro: string;
	quote: string;
	cite: string;
	slowScience: { text: string; href: string };
	paragraphs?: string[];
};

// =========================
// Content loading (YAML-driven data)
// =========================

// Load editable content from YAML (src/content/home/index.yaml)
const homeEntry = await getEntry("home", "index");
if (!homeEntry) throw new Error("Missing content entry: src/content/home/index.yaml");

const publicationsEditable = homeEntry.data.publicationsEditable as PublicationEditable[];
const newsItems = homeEntry.data.newsItems as NewsItem[];
const projectsEditable = homeEntry.data.projectsEditable as ProjectEditable[];
const experienceMeta =
	(homeEntry.data.experienceMeta ?? {}) as Record<string, { name: string; link: string }>;
const orderFromYaml = homeEntry.data.order as string[] | undefined;
const homeIntro = (homeEntry.data.homeIntro ?? null) as HomeIntro | null;
const acknowledgements = (homeEntry.data.acknowledgements ?? null) as Acknowledgements | null;
const personalPhilosophy = (homeEntry.data.personalPhilosophy ?? null) as PersonalPhilosophy | null;

// =========================
// Helpers (pure utilities)
// =========================

function escapeHtml(s: string) {
	return s
		.replaceAll("&", "&amp;")
		.replaceAll("<", "&lt;")
		.replaceAll(">", "&gt;")
		.replaceAll('"', "&quot;")
		.replaceAll("'", "&#039;");
}

function repoLabel(url: string): string {
	try {
		const u = new URL(url);
		const host = u.hostname.toLowerCase();
		if (host === "github.com" || host.endsWith(".github.com")) {
			return u.pathname.replace(/^\/+|\/+$/g, "");
		}
		return url;
	} catch {
		return url;
	}
}

// =========================
// Asset resolution (images/logos)
// =========================

const assetImages = import.meta.glob("../assets/**/*.{png,jpg,jpeg,svg,gif,webp}", {
	eager: true,
	import: "default",
});

function normalizeAssetKey(p: string): string {
	const s = p.trim();
	if (s.startsWith("../assets/")) return s;
	if (s.startsWith("/src/assets/")) return ".." + s.replace("/src", "");
	if (s.startsWith("/assets/")) return "../assets" + s.replace("/assets", "");
	return `../assets/${s}`;
}

function resolveAsset(p?: string): any | null {
	if (!p) return null;
	const key = normalizeAssetKey(p);
	return (assetImages as any)[key] ?? null;
}

function assetToSrc(a: any): string {
	if (!a) return "";
	return typeof a === "string" ? a : a.src;
}

// =========================
// Derived data (publications/projects/experiences/logos)
// =========================

const cactusTech: PublicationResolved[] = publicationsEditable.map((pub) => {
	const img = resolveAsset(pub.image);
	const vlogo = resolveAsset(pub.venueLogo);
	return { ...pub, image: img, fullSrc: assetToSrc(img), venueLogo: vlogo };
});

const projects = projectsEditable;

// Experiences (auto logos from /assets/exps)
const expImages = import.meta.glob("../assets/exps/*.{png,jpg,jpeg,svg,webp}", {
	eager: true,
	import: "default",
});

function expNumericOrder(file: string): number | null {
	const m = file.match(/^exp(\d+)\./i);
	return m ? Number(m[1]) : null;
}

const experiences = Object.entries(expImages)
	.map(([path, mod]: [string, any]) => {
		const file = path.split("/").pop() || "";
		const meta = experienceMeta[file] || { name: file, link: "#" };
		const altTitleName = meta.name.replace(/\s*\n\s*/g, " ");
		const tooltipHtml = escapeHtml(meta.name).replaceAll("\n", "<br/>");
		return { file, image: mod as any, name: meta.name, altTitleName, tooltipHtml, link: meta.link };
	})
	.sort((a, b) => {
		if (orderFromYaml?.length) {
			const ai = orderFromYaml.indexOf(a.file);
			const bi = orderFromYaml.indexOf(b.file);
			if (ai === -1 && bi === -1) return a.file.localeCompare(b.file);
			if (ai === -1) return 1;
			if (bi === -1) return -1;
			return ai - bi;
		}
		const an = expNumericOrder(a.file);
		const bn = expNumericOrder(b.file);
		if (an != null && bn != null) return an - bn;
		if (an != null) return -1;
		if (bn != null) return 1;
		return a.file.localeCompare(b.file);
	});

// Logos from /assets/logos
const logoImages = import.meta.glob("../assets/logos/*.{png,svg,jpg,jpeg,webp}", {
	eager: true,
	import: "default",
});

const LOGO_ALIASES: Record<string, string[]> = {
	whu: ["whu", "wuhan"],
};

function findLogoAny(keys: string | string[]) {
	const ks = Array.isArray(keys) ? keys : [keys];
	for (const sub of ks) {
		for (const path of Object.keys(logoImages)) {
			if (path.toLowerCase().includes(sub.toLowerCase())) {
				const mod: any = (logoImages as any)[path];
				return mod || null;
			}
		}
	}
	return null;
}

const introLogoKeys = new Set<string>(
	homeIntro?.paragraphs
		.flatMap((p) => p.segments)
		.filter((s): s is Extract<HomeIntroSegment, { type: "org" }> => s.type === "org")
		.map((s) => s.key) ?? [],
);

const projectLogoKeys = new Set<string>(projectsEditable.flatMap((p) => p.orgLogos ?? []));
const allLogoKeys = new Set<string>([...projectLogoKeys, ...introLogoKeys]);

const logoByKey: Record<string, any | null> = {};
for (const k of allLogoKeys) logoByKey[k] = findLogoAny(LOGO_ALIASES[k] ?? k);

const projectLogoByKey: Record<string, any | null> = Object.fromEntries(
	[...projectLogoKeys].map((k) => [k, logoByKey[k] ?? null]),
);
---

<PageLayout meta={{ title: "Home" }}>
	<section>
		<h1 class="title mb-6">Hello World!</h1>

		{/* Home description (YAML-driven via homeIntro) */}
		{homeIntro?.paragraphs.map((para) => (
			<p class="mb-3">
				{para.segments.map((seg) => {
					if (seg.type === "text") return <span set:html={seg.html} />;
					if (seg.type === "link")
						return (
							<a class={seg.class ?? "cactus-link"} href={seg.href}>
								{seg.name}
							</a>
						);
					// org (IMPORTANT: keep logo and link text adjacent: no whitespace node)
					const logo = logoByKey[seg.key];
					return (
						<>
							{logo ? (
								<Image
									src={logo}
									alt={seg.alt ?? `${seg.name} logo`}
									width={seg.width ?? 20}
									densities={[1, 2]}
									loading="eager"
									class={seg.class ?? "mr-0.5 ml-0.5 mb-1 inline h-4 w-auto object-contain"}
								/>
							) : null}<a class="cactus-link" href={seg.href}>{seg.name}</a>
						</>
					);
				})}
			</p>
		))}

		<SocialList />
	</section>

	<section class="mt-12" aria-label="News">
		<h2 class="title mb-4 text-xl">News</h2>
		<ul class="news-fade space-y-3 h-56 overflow-y-auto pr-2">
			{newsItems.map((item) => (
				<li class="flex gap-3">
					<span class="w-[5.5rem] shrink-0 font-medium font-mono text-gray-600 dark:text-gray-400">
						{item.date}
					</span>

					<div class="min-w-0 text-gray-700 dark:text-gray-300">
						{item.html ? (
							// NOTE: html is rendered as-is; only put trusted content here
							<span set:html={item.html} />
						) : (
							<>
								{item.text && <span set:html={escapeHtml(item.text)} />}
								{item.href && (
									<>
										{" "}
										<a class="cactus-link" href={item.href} target="_blank" rel="noopener">
											{item.label ?? "More"}
										</a>
									</>
								)}
							</>
						)}
					</div>
				</li>
			))}
		</ul>
	</section>

	<section class="mt-12" aria-label="Experiences">
		<h2 class="title mb-4 text-xl">Experiences</h2>
		<div class="flex flex-wrap items-center gap-6">
			{
				experiences.map((exp) => (
					<a
						href={exp.link}
						target="_blank"
						rel="noopener"
						class="group relative flex items-center justify-center p-1"
					>
						<Image
							src={exp.image}
							alt={exp.altTitleName}
							title={exp.altTitleName}
							width={256}
							densities={[1, 2]}
							class="h-16 w-auto object-contain transition-transform duration-200 group-hover:scale-105"
							loading="lazy"
						/>
						<span class="pointer-events-none absolute -bottom-7 left-1/2 -translate-x-1/2 whitespace-nowrap rounded bg-gray-800 px-2 py-0.5 text-[10px] font-medium leading-snug tracking-wide text-white opacity-0 shadow transition-opacity group-hover:opacity-100 text-center">
							<span set:html={exp.tooltipHtml} />
						</span>
					</a>
				))
			}
		</div>

		<br />

		{/* Acknowledgements (YAML-driven via acknowledgements) */}
		{acknowledgements && (
			<p class="mb-4 text-sm leading-relaxed text-gray-700 dark:text-gray-300">
				<b>{acknowledgements.title}</b><br />

				{acknowledgements.introLines?.map((l) => (
					<>
						{l}<br />
					</>
				))}

				{acknowledgements.mentors?.map((p, i) => (
					<>
						<a class="cactus-link" href={p.href}>{p.name}</a>
						{i < (acknowledgements.mentors?.length ?? 0) - 1 ? "," : ","}
						{i === (acknowledgements.mentors?.length ?? 0) - 1 ? <br /> : " "}
					</>
				))}

				{acknowledgements.peersIntro ? (
					<>
						{acknowledgements.peersIntro}<br />
					</>
				) : null}

				{acknowledgements.peers?.map((p, i) => (
					<>
						<a class="cactus-link" href={p.href}>{p.name}</a>
						{i < (acknowledgements.peers?.length ?? 0) - 1 ? "," : ""}
						{i === (acknowledgements.peers?.length ?? 0) - 1 ? (
							<>
								<br />{acknowledgements.outro ?? ""}
							</>
						) : " "}
					</>
				))}
			</p>
		)}
	</section>

	<section class="mt-16" aria-label="Publications">
		<h2 class="title mb-4 text-xl">Publications</h2>
		<dl class="space-y-4">
			{
				cactusTech.map((pub) => {
					const {
						author,
						title,
						booktitle,
						time,
						doi,
						paper,
						code,
						abstract,
						venueIcon,
						venueColor,
						venueRank,
						venueLogo,
						image,
						fullSrc,
					} = pub;

					const slug = title
						.toLowerCase()
						.replace(/\s+/g, "-")
						.replace(/[^a-z0-9\-]/g, "");

					return (
						<article class="pub-article group relative -ml-2 w-full overflow-hidden rounded-xl border border-zinc-200/70 bg-white/80 p-4 shadow-sm backdrop-blur transition hover:shadow-md supports-[backdrop-filter]:bg-white/70 dark:border-zinc-800/80 dark:bg-zinc-900/80">
							<div class="grid grid-cols-1 gap-4 lg:flex lg:items-start lg:gap-6">
								<div class="min-w-0 lg:flex-1">
									<h3 class="text-lg font-semibold leading-snug tracking-tight">
										<span class="text-accent">
											{title}
										</span>
									</h3>
									<p class="mt-1 text-gray-700 dark:text-gray-300">
										{author.map((name: string, index: number) => (
											<span style={{ fontWeight: name === "Xu Pan" ? "700" : "normal" }}>
												{name}{index < author.length - 1 && ","}
											</span>
										))}
									</p>
									<div class="mt-2 flex flex-wrap gap-2">
										<span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 font-medium text-sm text-gray-700 dark:bg-zinc-800 dark:text-gray-300">
											{venueLogo ? (
												<img
													src={assetToSrc(venueLogo)}
													alt="Venue logo"
													width="14"
													height="14"
													class="mr-1 inline-block h-[14px] w-[14px] object-contain align-[-0.2em]"
													loading="lazy"
													decoding="async"
												/>
											) : (
												venueIcon && (
													<Icon
														name={venueIcon}
														width="14"
														height="14"
														class="mr-1 inline-block align-[-0.2em]"
														style={`color: ${venueColor}`}
														aria-hidden="true"
													/>
												)
											)}
											{booktitle}
										</span>

										{venueRank && (
											<span class="rounded-full bg-accent/10 px-2 py-0.5 font-medium text-sm text-accent dark:bg-accent/15">
												{venueRank}
											</span>
										)}

										{time && (
											<span class="rounded-full bg-gray-100 px-2 py-0.5 font-medium text-sm text-gray-700 dark:bg-zinc-800 dark:text-gray-300">
												{time}
											</span>
										)}
									</div>
									<div class="mt-3 flex flex-wrap gap-2" aria-label="Publication actions">
										{abstract && (
											<button
												type="button"
												class="abstract-btn cactus-link inline-flex items-center rounded border border-zinc-300 px-2.5 py-1 text-xs font-medium text-gray-700 transition hover:bg-accent/10 dark:border-zinc-700 dark:text-gray-300"
												data-abstract-id={`abstract-${slug}`}
												aria-expanded="false"
											>
												ABSTRACT
												<svg
													class="chev ml-2 h-3 w-3 transform transition-transform duration-200"
													viewBox="0 0 20 20"
													fill="none"
													xmlns="http://www.w3.org/2000/svg"
													aria-hidden="true"
												>
													<path
														d="M6 8l4 4 4-4"
														stroke="currentColor"
														stroke-width="1.6"
														stroke-linecap="round"
														stroke-linejoin="round"
													/>
												</svg>
											</button>
										)}
										{code && (
											<a
												class="cactus-link inline-flex items-center rounded border border-zinc-300 px-2.5 py-1 text-xs font-medium text-gray-700 transition hover:bg-accent/10 dark:border-zinc-700 dark:text-gray-300"
												href={code}
												target="_blank"
												rel="noopener"
											>
												CODE
											</a>
										)}
										{doi && (
											<a
												class="cactus-link inline-flex items-center rounded border border-zinc-300 px-2.5 py-1 text-xs font-medium text-gray-700 transition hover:bg-accent/10 dark:border-zinc-700 dark:text-gray-300"
												href={doi}
												target="_blank"
												rel="noopener"
											>
												DOI
											</a>
										)}
										{paper && (
											<a
												class="cactus-link inline-flex items-center rounded border border-zinc-300 px-2.5 py-1 text-xs font-medium text-gray-700 transition hover:bg-accent/10 dark:border-zinc-700 dark:text-gray-300"
												href={paper}
												target="_blank"
												rel="noopener"
											>
												PAPER
											</a>
										)}
									</div>
								</div>

								{/* thumbnail column (part of flow on large screens). Keep hidden on small screens. */}
								{image && (
									<div class="pub-thumb hidden lg:ml-2 lg:block">
										<button
											type="button"
											class="pub-thumb-btn group block cursor-zoom-in"
											aria-label="Open image"
										>
											<Image
												src={image}
												alt="[Thumbnail]"
												width={176}
												height={96}
												densities={[1, 2]}
												data-fullsrc={fullSrc}
												class="pub-thumb-img h-[96px] w-[176px] rounded-xl border-2 border-transparent object-cover shadow-md transition duration-200 group-hover:scale-[1.04] group-hover:border-dashed group-hover:border-accent group-hover:shadow-lg"
												loading="lazy"
												decoding="async"
											/>
										</button>
									</div>
								)}
							</div>

							{abstract && (
								<div
									class="abstract-collapse mt-3 w-full overflow-hidden text-gray-700 transition-[max-height,opacity] duration-300 ease-in-out dark:text-gray-300"
									id={`abstract-content-${slug}`}
									style="max-height: 0; opacity: 0;"
									data-collapsed="true"
								>
									{abstract}
								</div>
							)}
						</article>
					);
				})
			}
		</dl>
	</section>
	<section class="mt-16" aria-label="Projects">
		<h2 class="title mb-4 text-xl">Projects</h2>

		<div class="grid -ml-2 grid-cols-1 gap-4 md:grid-cols-2">
			{projects.map((p) => (
				<article class="group relative w-full overflow-hidden rounded-xl border border-zinc-200/70 bg-white/80 p-4 shadow-sm backdrop-blur transition hover:shadow-md supports-[backdrop-filter]:bg-white/70 dark:border-zinc-800/80 dark:bg-zinc-900/80">
					<div class="min-w-0">
						<div class="flex flex-wrap items-center gap-2">
							<h3 class="text-lg font-semibold leading-snug tracking-tight text-accent">
								{p.name}
							</h3>
							{p.time && (
								<span class="rounded-full bg-gray-100 px-2 py-0.5 font-medium text-sm text-gray-700 dark:bg-zinc-800 dark:text-gray-300">
									{p.time}
								</span>
							)}
						</div>

						<p class="mt-2 text-gray-700 dark:text-gray-300">{p.description}</p>

						{p.tags && p.tags.length > 0 && (
							<div class="mt-2 flex flex-wrap gap-2">
								{p.tags.map((t) => (
									<span class="rounded-full bg-accent/10 px-2 py-0.5 font-medium text-sm text-accent dark:bg-accent/15">
										{t}
									</span>
								))}
							</div>
						)}

						<div class="mt-3 flex items-center justify-between gap-3" aria-label="Project links">
							<div class="flex flex-wrap gap-2 min-w-0">
								{p.repo && (
									<a
										class="inline-flex items-center gap-1.5 rounded border border-zinc-300 px-2.5 py-1 text-xs font-medium text-gray-700 transition hover:bg-accent/10 dark:border-zinc-700 dark:text-gray-300 dark:hover:bg-accent/15"
										href={p.repo}
										target="_blank"
										rel="noopener"
										aria-label={`GitHub repo: ${repoLabel(p.repo)}`}
									>
										<Icon
											name="simple-icons:github"
											width="14"
											height="14"
											class="inline-block"
											aria-hidden="true"
										/>
										<span class="truncate">{repoLabel(p.repo)}</span>
									</a>
								)}

								{p.demo && (
									<a
										class="cactus-link inline-flex items-center rounded border border-zinc-300 px-2.5 py-1 text-xs font-medium text-gray-700 transition hover:bg-accent/10 dark:border-zinc-700 dark:text-gray-300"
										href={p.demo}
										target="_blank"
										rel="noopener"
									>
										DEMO
									</a>
								)}
								{p.paper && (
									<a
										class="cactus-link inline-flex items-center rounded border border-zinc-300 px-2.5 py-1 text-xs font-medium text-gray-700 transition hover:bg-accent/10 dark:border-zinc-700 dark:text-gray-300"
										href={p.paper}
										target="_blank"
										rel="noopener"
									>
										PAPER
									</a>
								)}
							</div>

							{p.orgLogos?.length ? (
								<div class="shrink-0 flex items-center">
									{p.orgLogos.map((k) => {
										const src = projectLogoByKey[k];
										return (
											src && (
												<Image
													src={src}
													alt={`${k} logo`}
													width={28}
													densities={[1, 2]}
													loading="lazy"
													class="ml-1 inline h-6 w-auto object-contain opacity-90"
												/>
											)
										);
									})}
								</div>
							) : null}
						</div>
					</div>
				</article>
			))}
		</div>
	</section>

	<section class="mt-12" aria-label="Personal Philosophy">
		<h2 class="title mb-4 text-xl">Personal Philosophy</h2>

		{personalPhilosophy && (
			<>
				<p class="mb-4">{personalPhilosophy.intro}</p>

				<figure class="relative border-l-4 border-accent pl-4">
					<blockquote class="italic">{personalPhilosophy.quote}</blockquote>
					<figcaption class="mt-2 text-right text-gray-600 dark:text-gray-400">
						{personalPhilosophy.cite}
					</figcaption>
				</figure>

				<p class="mt-4 mb-4">
					I resonate with the spirit of{" "}
					<a
						class="cactus-link"
						href={personalPhilosophy.slowScience.href}
						target="_blank"
						rel="noopener"
					>
						{personalPhilosophy.slowScience.text}
					</a>
					.
				</p>

				{(personalPhilosophy.paragraphs ?? []).map((t) => (
					<p class="mt-4 mb-4">{t}</p>
				))}
			</>
		)}
	</section>

	<div
		id="img-modal"
		class="z-70 fixed inset-0 flex hidden items-center justify-center bg-black/40 p-4 backdrop-blur-sm"
	>
		<div class="relative flex max-h-[90vh] max-w-[90vw] items-center justify-center">
			<button
				id="img-modal-close"
				class="absolute right-3 top-3 z-20 inline-flex h-9 w-9 items-center justify-center rounded-full bg-white/90 text-accent shadow-md hover:bg-white"
				aria-label="Close image modal"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					viewBox="0 0 24 24"
					width="16"
					height="16"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
					stroke-linecap="round"
					stroke-linejoin="round"
					aria-hidden="true"
				>
					<line x1="18" y1="6" x2="6" y2="18"></line>
					<line x1="6" y1="6" x2="18" y2="18"></line>
				</svg>
			</button>
			<img
				id="img-modal-img"
				src=""
				alt="Large image"
				class="max-h-[90vh] max-w-full rounded-lg object-contain shadow-xl"
			/>
		</div>
	</div>

	<script>
		// UI behaviors: abstract toggle + image modal
		function onReady(fn: () => void): void {
			if (document.readyState === "loading")
				document.addEventListener("DOMContentLoaded", fn, { once: true });
			else fn();
		}

		function initAbstractToggles() {
			const buttons = document.querySelectorAll(".abstract-btn");
			buttons.forEach((btn) => {
				const id = btn.getAttribute("data-abstract-id");
				const slug = id ? id.replace("abstract-", "") : null;
				const content = slug ? document.getElementById(`abstract-content-${slug}`) : null;
				const chev = btn.querySelector(".chev");

				const syncChevron = () => {
					if (!chev || !content) return;
					const expanded = content.getAttribute("data-collapsed") === "false";
					chev.classList.toggle("rotate-180", expanded);
					btn.setAttribute("aria-expanded", expanded ? "true" : "false");
				};

				syncChevron();

				btn.addEventListener("click", () => {
					if (!content) return;

					const isCollapsed = content.getAttribute("data-collapsed") !== "false";
					if (isCollapsed) {
						content.style.maxHeight = content.scrollHeight + "px";
						content.style.opacity = "1";
						content.setAttribute("data-collapsed", "false");

						// allow transition to finish, then unlock height
						setTimeout(() => {
							if (content.getAttribute("data-collapsed") === "false") content.style.maxHeight = "none";
						}, 310);
					} else {
						content.style.maxHeight = content.scrollHeight + "px";
						content.getBoundingClientRect(); // force reflow
						content.style.maxHeight = "0";
						content.style.opacity = "0";
						content.setAttribute("data-collapsed", "true");
					}
					syncChevron();
				});
			});
		}

		function initImageModal(): void {
			const imgModal = document.getElementById("img-modal") as HTMLDivElement | null;
			const imgModalImg = document.getElementById("img-modal-img") as HTMLImageElement | null;
			const imgModalClose = document.getElementById("img-modal-close") as HTMLButtonElement | null;

			if (!imgModal || !imgModalImg) return;

			// Bind non-null references so TS is happy inside nested functions/handlers.
			const modal = imgModal;
			const modalImg = imgModalImg;
			const modalClose = imgModalClose;

			function open(src: string): void {
				modalImg.src = src;
				modal.classList.remove("hidden");
				document.body.style.overflow = "hidden";
				modalClose?.focus?.();
			}

			function close(): void {
				modal.classList.add("hidden");
				modalImg.src = "";
				document.body.style.overflow = "";
			}

			modalClose?.addEventListener("click", close);
			modal.addEventListener("click", (e: MouseEvent) => {
				if (e.target === modal) close();
			});
			document.addEventListener("keydown", (e: KeyboardEvent) => {
				if (e.key === "Escape") close();
			});

			// Delegate click from publication thumbnails only
			document.addEventListener("click", (e: MouseEvent) => {
				const t = e.target;
				if (!(t instanceof HTMLImageElement)) return;
				if (!t.classList.contains("pub-thumb-img")) return;
				const src = t.dataset?.fullsrc || t.currentSrc || t.src;
				if (src) open(src);
			});
		}

		onReady(() => {
			initAbstractToggles();
			initImageModal();
		});
	</script>

	<style>
		:global(.news-fade) {
			-webkit-mask-image: linear-gradient(
				to bottom,
				#000 0%,
				#000 calc(100% - 2.5rem),
				transparent 100%
			);
			mask-image: linear-gradient(
				to bottom,
				#000 0%,
				#000 calc(100% - 2.5rem),
				transparent 100%
			);
			-webkit-mask-size: 100% 100%;
			mask-size: 100% 100%;
			-webkit-mask-repeat: no-repeat;
			mask-repeat: no-repeat;
		}
	</style>
</PageLayout>
